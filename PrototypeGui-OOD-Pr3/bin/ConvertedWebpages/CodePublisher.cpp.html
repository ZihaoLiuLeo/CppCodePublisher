<DOCTYPE !HTML>
<html>
  <head>
    <Title>CodePublisher.h</Title>
    <script src="script.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>

  <body>
    <span class="absolute">
      <label><input type="checkbox" id ="hideF" value="hidefuncs" checked="true" onclick="toggleVisibility('function')">Functions</label><br>
      <label><input type="checkbox" id ="hideC" value="hideclass" checked="true" onclick="toggleVisibility('class')">Classes</label><br>
      <label><input type="checkbox" id ="hidec" value="hidecomms" checked="true" onclick="toggleVisibility('comment')">Comments</label><br>
    </span>
    <h3>Dependencies: 
      <a href=".html"></a>
      <a href="CodePublisher.cpp.html">CodePublisher.cpp</a>
    </h3>    <pre>
#pragma once
<span class="comment">///////////////////////////////////////////////////////////////////////////
// CodePublisher.h : defines facade/executive for OOD Pr1 S19            //
// ver 2.0                                                               //
//                                                                       // 
// Application   : OOD-S19 Instructor Solution                           //
// Platform      : Visual Studio Community 2017, Windows 10 Pro x64      //
// Author        : Ammar Salman, Syracuse University                     //
//                 313/788-4694, assalman@syr.edu                        //
///////////////////////////////////////////////////////////////////////////</span>
<span class="comment">/*
*  Package Operations:
* =======================
*  This package defines CodePublisher which uses different components of
*  CodeConverter, Display and DirectoryN to put together the entire 
*  functionality of the CodePublisher. The mentioned packages are indep-
*  ndent of each other and their only interaction is through this facade
*
*  NOTE: there are TWO modes for compiling this file:
*   1) Preprocessor DEMO_CP : runs in full demo mode for Pr1.
*   2) Preprocessor USE_CP  : runs normal functionality. 
*
*  Required Files:
* =======================
*  CodePublisher.h CodePublisher.cpp CodeUtilities.h
*  Converter.h Converter.cpp DirExplorerN.h DirExplorerN.cpp
*  Display.h Display.cpp Logger.h Logger.cpp 
*
*  Maintainence History:
* =======================
*  ver 2.0 - 27 Mar 2019
*  - added file parsing support to extract information
*  - added automated dependency analysis support 
*  - function 'extractFiles' is no longer public, it's replaced with 'configure()'
*  ver 1.0 - 14 Feb 2019
*  - first release
*/</span>

#include &lt;string&gt;
#include &lt;vector&gt;
#include "ICodePublisher.h"

#include "../Utilities/CodeUtilities/CodeUtilities.h"

class CodePublisher : public ICodePublisher
<span class="class">{
public:
  CodePublisher();

  bool processCommandLineArgs(int argc, char ** argv);
  
  void workingDirectory(const std::string& dir);
  const std::string& workingDirectory() const;

  void outputDirectory(const std::string& dir);
  const std::string& outputDirectory() const; 

  bool configure();

  void publish();
  void publish(const std::string& file);
  void publish(const std::vector&lt;std::string&gt;& files);

  void storeArgs(std::vector&lt;std::string&gt;& sArgv);

  std::vector&lt;std::string&gt;& getArg();

  Utilities::DisplayMode displayMode() const;

  

private:
  Utilities::ProcessCmdLine *pcl_;
  bool extractFiles();
  void analyzeFiles();
  <span class="comment">/*CodeConverter cconv_;
  Display display_;

  std::string dirIn_; 
  std::string dirOut_;

  std::vector&lt;std::string&gt; files_;

  */</span>

  <span class="comment">//std::vector&lt;std::string&gt; _sarg;</span>

}</span>;

inline ICodePublisher* ICodePublisher::create()
<span class="function">{
	ICodePublisher* pCP = new CodePublisher();
	return pCP;
}</span>

    </pre>
  </body>
</html>
<DOCTYPE !HTML>
<html>
  <head>
    <Title>CodePublisher.cpp</Title>
    <script src="script.js"></script>
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>

  <body>
    <span class="absolute">
      <label><input type="checkbox" id ="hideF" value="hidefuncs" checked="true" onclick="toggleVisibility('function')">Functions</label><br>
      <label><input type="checkbox" id ="hideC" value="hideclass" checked="true" onclick="toggleVisibility('class')">Classes</label><br>
      <label><input type="checkbox" id ="hidec" value="hidecomms" checked="true" onclick="toggleVisibility('comment')">Comments</label><br>
    </span>
    <h3>Dependencies: 
      <a href=".html"></a>
      <a href="CodePublisher.h.html">CodePublisher.h</a>
    </h3>    <pre>
<span class="comment">///////////////////////////////////////////////////////////////////////////
// CodePublisher.cpp : defines facade/executive for OOD Pr1 S19          //
// ver 2.0                                                               //
//                                                                       // 
// Application   : OOD-S19 Instructor Solution                           //
// Platform      : Visual Studio Community 2017, Windows 10 Pro x64      //
// Author        : Ammar Salman, Syracuse University                     //
//                 313/788-4694, assalman@syr.edu                        //
///////////////////////////////////////////////////////////////////////////</span>

#include "CodePublisher.h"
#include "../FileProcessor/FileProcessor.h"
#include "../DependencyAnalysis/DependencyAnalysis.h"
#include "../Logger/Logger.h"

using namespace Utilities;
using namespace LoggingNew;
using namespace FileSystem;

ProcessCmdLine::Usage customUsage();

CodePublisher::CodePublisher()
<span class="function">{
}</span>

<span class="comment">// -----&lt; process cmd to get info &gt;------------------------------------</span>
bool CodePublisher::processCommandLineArgs(int argc, char ** argv)
<span class="function">{
  pcl_ = new ProcessCmdLine(argc, argv); 
  pcl_-&gt;usage(customUsage());

  preface("Command Line: ");
  pcl_-&gt;showCmdLine();

  if (pcl_-&gt;parseError())
  {
    pcl_-&gt;usage();
    std::cout &lt;&lt; "\n\n";
    return false;
  }
  dirIn_ = pcl_-&gt;path();
  return true;
}</span>

void CodePublisher::workingDirectory(const std::string & dir)
<span class="function">{
  dirIn_ = dir;
}</span>

<span class="comment">// -----&lt; return input directory - from PCL &gt;----------------------------</span>
const std::string & CodePublisher::workingDirectory() const
<span class="function">{
  return dirIn_;
}</span>

<span class="comment">// -----&lt; set output directory &gt;-----------------------------------------</span>
void CodePublisher::outputDirectory(const std::string & dir)
<span class="function">{
  dirOut_ = dir; 
  cconv_.outputDir(dir);
}</span>

<span class="comment">// -----&lt; return output directory &gt;--------------------------------------</span>
const std::string & CodePublisher::outputDirectory() const
<span class="function">{
  return dirOut_;
}</span>

<span class="comment">// -----&lt; configure publisher - extract files and analyze them &gt;---------</span>
bool CodePublisher::configure()
<span class="function">{
  if (extractFiles()) {
    analyzeFiles();
    return true;
  }
  return false;
}</span>

<span class="comment">// -----&lt; private: extract files - after processing cmd &gt;----------------</span>
bool CodePublisher::extractFiles()
<span class="function">{
  DirExplorerN de(pcl_-&gt;path());
  <span class="comment">//std::cout &lt;&lt; pcl_-&gt;path() &lt;&lt; std::endl;</span>
  for (auto patt : pcl_-&gt;patterns())
  {
    de.addPattern(patt);
  }

  if (pcl_-&gt;hasOption("s"))
  {
    de.recurse();
  }

  bool res = de.search() && de.match_regexes(pcl_-&gt;regexes());
  de.showStats();

  files_ = de.filesList();

  return res;
}</span>

<span class="comment">// -----&lt; private: analyze - extracts info, dep analysis &gt;--------------</span>
void CodePublisher::analyzeFiles()
<span class="function">{
  <span class="comment">// extract line information (scopes) and include statements</span>
  FileProcessor fp;
  fp.filelist(files_);
  fp.processFiles();

  <span class="comment">// perform dependency analysis using include statemetns</span>
  DependencyAnalysis da;
  da.filelist(files_);
  da.includeList(fp.fileIncludes());
  da.performAnalysis();

  <span class="comment">// configure converter to analysis results</span>
  cconv_.setDepTable(da.analysisResult());
  cconv_.setFileLineInfo(fp.fileLineInfo());
}</span>


<span class="comment">// -----&lt; publish - files extracted from directory explorer &gt;---------------</span>
void CodePublisher::publish()
<span class="function">{
	
  display_.display(cconv_.convert(files_));
}</span>

<span class="comment">// -----&lt; publish - single file &gt;-------------------------------------------</span>
void CodePublisher::publish(const std::string & file)
<span class="function">{
  display_.display(cconv_.convert(file));
}</span>

<span class="comment">// -----&lt; publish - must provide list &gt;-------------------------------------</span>
void CodePublisher::publish(const std::vector&lt;std::string&gt;& files)
<span class="function">{
  display_.display(cconv_.convert(files));
}</span>



std::vector&lt;std::string&gt;& CodePublisher::getArg()
<span class="function">{
	return _sarg;
}</span>

<span class="comment">// -----&lt; gets display mode as set by PCL &gt;---------------------------------</span>
Utilities::DisplayMode CodePublisher::displayMode() const
<span class="function">{
  return pcl_-&gt;displayMode();
}</span>


<span class="comment">// -----&lt; command line usage &gt;----------------------------------------------</span>
ProcessCmdLine::Usage customUsage()
<span class="function">{
  std::string usage;
  usage += "\n  Command Line: path [/option]* [/pattern]* [/regex]*";
  usage += "\n    path is relative or absolute path where processing begins";
  usage += "\n    [/option]* are one or more options of the form:";
  usage += "\n      /s     - walk directory recursively";
  usage += "\n      /demo  - run in demonstration mode (cannot coexist with /debug)";
  usage += "\n      /debug - run in debug mode (cannot coexist with /demo)";
  <span class="comment">//usage += "\n      /h - hide empty directories";
  //usage += "\n      /a - on stopping, show all files in current directory";</span>
  usage += "\n    [pattern]* are one or more pattern strings of the form:";
  usage += "\n      *.h *.cpp *.cs *.txt or *.*";
  usage += "\n    [regex] regular expression(s), i.e. [A-B](.*)";
  usage += "\n";
  return usage;
}</span>

<span class="comment">// -----&lt; initialize loggers in proper display mode &gt;------------------------</span>
void initializeLoggers(DisplayMode dm) <span class="function">{
  if (dm == DisplayMode::Debug) {
    LoggerDebug::attach(&std::cout);
    LoggerDebug::start();
  }

  else if (dm == DisplayMode::Demo) {
    LoggerDemo::attach(&std::cout);
    LoggerDemo::start();
  }
}</span>

<span class="comment">// -----&lt; stop loggers &gt;-----------------------------------------------------</span>
void stopLoggers() <span class="function">{
  LoggerDemo::stop();
  LoggerDebug::stop();
}</span>

void CodePublisher::storeArgs(std::vector&lt;std::string&gt;& sArgv)
<span class="function">{
	_sarg = sArgv;
	std::vector&lt;char*&gt; cargv;
	cargv.reserve(sArgv.size());
	for (size_t i = 0; i &lt; sArgv.size(); i++)
	{
		std::cout &lt;&lt; sArgv[i] &lt;&lt; std::endl;
		cargv.push_back(const_cast&lt;char*&gt;(sArgv[i].c_str()));
	}
	std::cout &lt;&lt; cargv.size() &lt;&lt; '\n';
	processCommandLineArgs(cargv.size(), &cargv[0]);
	initializeLoggers(displayMode());

	if (!configure()) {
		stopLoggers();
		std::cout &lt;&lt; "\n  Found no files to process. Terminating.\n\n";
	}
}</span>



#ifdef DEMO_CP

#include &lt;iostream&gt;

<span class="comment">// -----&lt; demonstrate requirement 3 &gt;----------------------------------------------</span>
void demoReq3() <span class="function">{
  LoggerDemo::write("\n");
  LoggerDemo::title("Demonstrating Requirement #3 - Packages");
  LoggerDemo::write("\n  Converter & Display packages are available. Executive was replaced with ");
  LoggerDemo::write("\n  CodePublisher which also acts as facade for the entire project.\n");
}</span>


<span class="comment">// -----&lt; demonstrate requirements 4 and 5 &gt;---------------------------------------</span>
int demoReq45(CodePublisher& cp, int argc, char ** argv) <span class="function">{
  LoggerDemo::write("\n");
  LoggerDemo::title("Demonstrating Requirements #4 & #5 - command line arguments");
  LoggerDemo::write(customUsage());

  if (argc &lt; 2) return 1; <span class="comment">// even before processing, if no path, just reject it</span>

  LoggerDemo::write("\n  Changing cmd path to ../debug to test Requirement 5\n");

  <span class="comment">// cmd has the path always as first arg... we so change it to find no files</span>
  char * tmp = new char[sizeof(argv[1])];
  strcpy_s(tmp, sizeof(tmp), argv[1]);
  argv[1] = new char[9];
  strcpy_s(argv[1], 9, "../debug"); // no files will be found matching this
  
  if (!cp.processCommandLineArgs(argc, argv)) return 1; <span class="comment">// just in case</span>

  if (!cp.configure()) {
    LoggerDemo::write("\n\n  No files found in the current directory. We will ");
    LoggerDemo::write("\n  continue since we deliberately changed argv[1] to ");
    LoggerDemo::write("\n  test Requirement 5. After restoring argv[1], if there ");
    LoggerDemo::write("\n  are no files to process, the program will terminate. \n");
  }

  LoggerDemo::write("\n\n  Changing back cmd path to original to continue demonstartion.\n");
  delete argv[1];
  argv[1] = tmp;

  if (!cp.processCommandLineArgs(argc, argv)) return 1; <span class="comment">// just in case</span>
  if (!cp.configure()) { <span class="comment">// if this fails, then there are no files to process at all</span>
    return 2; <span class="comment">// the demo will end after this</span>
  }

  return 0;
}</span>

<span class="comment">// -----&lt; demonstrate requirements 6 and 7 &gt;------------------------------</span>
void demoReq67(CodePublisher& cp) <span class="function">{
  LoggerDemo::write("\n");
  LoggerDemo::title("Demonstrating Requirements #6 & #7 - Convert and Display");
  cp.publish();
}</span>


<span class="comment">// -----&lt; demonstrate requirement 8 &gt;-------------------------------------</span>
void demoReq8() <span class="function">{
  LoggerDemo::write("\n");
  LoggerDemo::title("Demonstrating Requirement #8 - Automated Test Unit");
  LoggerDemo::write("\n  Well, this is the automated test unit.");
  LoggerDemo::write("\n\n  All Requirements met. ");

}</span>


<span class="comment">// -----&lt; DEMONSTRATION MAIN &gt;---------------------------------------------</span>
int main(int argc, char ** argv) <span class="function">{
  <span class="comment">// the following processing of cmd is not official, it's only
  // done to allow for demo/debug modes BEFORE CodePublisher does
  // its own processing of cmds..</span>

  initializeLoggers(Utilities::DisplayMode::Debug); <span class="comment">// by default go debug</span>
  for (int i = 0; i &lt; argc; i++) {
    std::string arg = argv[i];
    if (arg == "/demo") { // only go demo once told 
      stopLoggers();
      initializeLoggers(Utilities::DisplayMode::Demo);
      break;
    }
  }

  demoReq3();
  
  CodePublisher cp;

  int err = demoReq45(cp, argc, argv);
  if (err == 1) {
    LoggerDemo::write("\n  Invalid command line args.\n  Ending demonstration...\n");
    return 1;
  }
  else if (err == 2) {
    LoggerDemo::write("\n  The given path has no files matching patterns and/or regexes.");
    LoggerDemo::write("\n  Ending demonstration...\n");
    return 2;
  }
  
  demoReq67(cp);
  demoReq8();

  stopLoggers();
  return 0;
}</span>

#endif

#ifdef USE_CP

#include &lt;iostream&gt;

<span class="comment">// -----&lt; NORMAL USE MAIN &gt; ------------------------------------------</span>
int main(int argc, char ** argv) <span class="function">{
  CodePublisher cp;
  if (!cp.processCommandLineArgs(argc, argv)) {
    std::cout &lt;&lt; "\n  Failed to process command line arguments. Terminating\n\n";
    return 1;
  }

  initializeLoggers(cp.displayMode());

  if (!cp.configure()) {
    stopLoggers();
    std::cout &lt;&lt; "\n  Found no files to process. Terminating.\n\n";
    return 0; 
  }

  cp.publish();
  stopLoggers();
  return 0;
}</span>

#endif
    </pre>
  </body>
</html>
